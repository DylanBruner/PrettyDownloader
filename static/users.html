<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PrettyDownloader - User Management</title>

  <!-- Favicon -->
  <link rel="icon" href="/static/img/favicon.png" type="image/png">

  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Custom CSS -->
  <link href="/static/css/style.css" rel="stylesheet">

  <!-- Alpine.js -->
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.10.3/dist/cdn.min.js" defer></script>
</head>
<body class="flex flex-col min-h-screen">
  <!-- The sidebar will be dynamically inserted by sidebar.js -->

  <!-- Main content -->
  <div class="flex-1 ml-0 md:ml-64 transition-all duration-300">
    <!-- The topbar will be dynamically inserted by topbar.js -->

    <!-- Page content -->
    <main class="p-4 md:p-6">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Users list -->
        <div class="lg:col-span-2">
          <div class="card p-4">
            <h2 class="text-xl font-semibold mb-4">Users</h2>
            <div id="users-list" class="mt-4">
              <div class="flex justify-center p-8">
                <div class="loader"></div>
              </div>
            </div>
          </div>

          <!-- Pending Users -->
          <div class="card p-4 mt-6">
            <h2 class="text-xl font-semibold mb-4">Pending Registrations</h2>
            <div id="pending-users-list" class="mt-4">
              <div class="flex justify-center p-8">
                <div class="loader"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Add user form -->
        <div class="lg:col-span-1">
          <div class="card p-4">
            <h2 class="text-xl font-semibold mb-4">Add New User</h2>
            <form id="add-user-form">
              <div class="mb-4">
                <label for="new-username" class="block text-sm font-medium mb-2">Username</label>
                <input type="text" id="new-username" class="form-input w-full" required>
              </div>

              <div class="mb-4">
                <label for="new-password" class="block text-sm font-medium mb-2">Password</label>
                <input type="password" id="new-password" class="form-input w-full" required>
              </div>

              <div class="mb-4">
                <label class="flex items-center">
                  <input type="checkbox" id="new-is-admin" class="mr-2">
                  <span>Admin privileges</span>
                </label>
                <p class="text-xs text-gray-400 mt-1">Admins are exempt from download quotas</p>
              </div>

              <div class="mb-4">
                <button
                  type="button"
                  id="toggle-quota-settings"
                  class="flex items-center justify-between w-full p-2 bg-gray-700 rounded hover:bg-gray-600 transition-colors"
                  onclick="toggleQuotaSettings()"
                >
                  <span class="font-medium">Download Quotas</span>
                  <i class="fas fa-chevron-down" id="quota-chevron"></i>
                </button>

                <div id="quota-settings" class="hidden mt-3 p-3 bg-gray-700 rounded">
                  <div class="mb-4">
                    <label for="new-daily-quota" class="block text-sm font-medium mb-2">Daily Quota</label>
                    <input type="number" id="new-daily-quota" class="form-input w-full" min="0" step="1" value="0">
                    <p class="text-xs text-gray-400 mt-1">Maximum downloads per day (0 = unlimited)</p>
                  </div>

                  <div class="mb-4">
                    <label for="new-weekly-quota" class="block text-sm font-medium mb-2">Weekly Quota</label>
                    <input type="number" id="new-weekly-quota" class="form-input w-full" min="0" step="1" value="0">
                    <p class="text-xs text-gray-400 mt-1">Maximum downloads per week (0 = unlimited)</p>
                  </div>

                  <div class="mb-2">
                    <label for="new-monthly-quota" class="block text-sm font-medium mb-2">Monthly Quota</label>
                    <input type="number" id="new-monthly-quota" class="form-input w-full" min="0" step="1" value="0">
                    <p class="text-xs text-gray-400 mt-1">Maximum downloads per month (0 = unlimited)</p>
                  </div>
                </div>
              </div>

              <button type="submit" class="btn btn-primary w-full">
                <i class="fas fa-user-plus mr-2"></i> Add User
              </button>
            </form>
          </div>

          <!-- User stats -->
          <div class="card p-4 mt-6">
            <h2 class="text-xl font-semibold mb-4">User Statistics</h2>
            <div class="grid grid-cols-2 gap-4">
              <div class="bg-gray-700 rounded-lg p-4 text-center">
                <div class="text-3xl font-bold mb-2" id="total-users-count">0</div>
                <div class="text-sm text-gray-400">Total Users</div>
              </div>
              <div class="bg-gray-700 rounded-lg p-4 text-center">
                <div class="text-3xl font-bold mb-2" id="admin-users-count">0</div>
                <div class="text-sm text-gray-400">Admins</div>
              </div>
            </div>
          </div>

          <!-- Invite Links -->
          <div class="card p-4 mt-6">
            <h2 class="text-xl font-semibold mb-4">Invite Links</h2>
            <p class="text-sm text-gray-400 mb-4">Create invite links to allow new users to register without admin approval.</p>

            <button id="create-invite-btn" class="btn btn-primary w-full mb-4">
              <i class="fas fa-plus-circle mr-2"></i> Create New Invite Link
            </button>

            <div id="invites-list" class="mt-4">
              <div class="flex justify-center p-8">
                <div class="loader"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 p-4 text-center text-gray-400 text-sm">
      <p></p>
    </footer>
  </div>

  <!-- Change Password Modal -->
  <div id="change-password-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
    <div class="absolute inset-0 bg-black bg-opacity-50"></div>
    <div class="card p-6 max-w-md w-full z-10">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">Change Password</h3>
        <button onclick="hideChangePasswordModal()" class="text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <p class="mb-4">Change password for: <span id="change-password-username" class="font-semibold"></span></p>

      <form id="change-password-form" class="mt-4">
        <div class="mb-4">
          <label for="new-password" class="block text-sm font-medium mb-2">New Password</label>
          <input type="password" id="change-password-input" class="form-input w-full" required>
        </div>

        <div class="flex justify-end gap-2 mt-6">
          <button
            type="button"
            onclick="hideChangePasswordModal()"
            class="btn bg-gray-600 text-white hover:bg-gray-700"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="btn btn-primary"
          >
            <i class="fas fa-save mr-1"></i> Save
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Quota Modal -->
  <div id="quota-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
    <div class="absolute inset-0 bg-black bg-opacity-50"></div>
    <div class="card p-6 max-w-md w-full z-10">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">Edit Download Quotas</h3>
        <button onclick="hideQuotaModal()" class="text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <p class="mb-4">Edit quotas for: <span id="quota-username" class="font-semibold"></span></p>
      <p class="text-sm text-gray-400 mb-4">Set to 0 for unlimited downloads.</p>

      <form id="quota-form" class="mt-4">
        <div class="mb-4">
          <label for="daily-quota" class="block text-sm font-medium mb-2">Daily Quota</label>
          <input type="number" id="daily-quota" class="form-input w-full" min="0" step="1" required>
          <p class="text-xs text-gray-400 mt-1">Maximum downloads per day</p>
        </div>

        <div class="mb-4">
          <label for="weekly-quota" class="block text-sm font-medium mb-2">Weekly Quota</label>
          <input type="number" id="weekly-quota" class="form-input w-full" min="0" step="1" required>
          <p class="text-xs text-gray-400 mt-1">Maximum downloads per week</p>
        </div>

        <div class="mb-4">
          <label for="monthly-quota" class="block text-sm font-medium mb-2">Monthly Quota</label>
          <input type="number" id="monthly-quota" class="form-input w-full" min="0" step="1" required>
          <p class="text-xs text-gray-400 mt-1">Maximum downloads per month</p>
        </div>

        <div class="flex justify-end gap-2 mt-6">
          <button
            type="button"
            onclick="hideQuotaModal()"
            class="btn bg-gray-600 text-white hover:bg-gray-700"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="btn btn-primary"
          >
            <i class="fas fa-save mr-1"></i> Save
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Create Invite Modal -->
  <div id="create-invite-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
    <div class="absolute inset-0 bg-black bg-opacity-50"></div>
    <div class="card p-6 max-w-md w-full z-10">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">Create Invite Link</h3>
        <button onclick="hideCreateInviteModal()" class="text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <p class="text-sm text-gray-400 mb-4">Create an invite link that allows a new user to register without admin approval.</p>

      <form id="create-invite-form" class="mt-4">
        <div class="mb-4">
          <label for="invite-expiry-days" class="block text-sm font-medium mb-2">Expires After (days)</label>
          <input type="number" id="invite-expiry-days" class="form-input w-full" min="1" step="1" value="7" required>
          <p class="text-xs text-gray-400 mt-1">Number of days until the invite expires</p>
        </div>

        <div class="mb-4">
          <label for="invite-max-uses" class="block text-sm font-medium mb-2">Maximum Uses</label>
          <input type="number" id="invite-max-uses" class="form-input w-full" min="1" step="1" value="1" required>
          <p class="text-xs text-gray-400 mt-1">Number of times this invite can be used</p>
        </div>

        <div class="mb-4">
          <label class="flex items-center">
            <input type="checkbox" id="invite-is-admin" class="mr-2">
            <span>Admin privileges</span>
          </label>
          <p class="text-xs text-gray-400 mt-1">Grant admin privileges to users who register with this invite</p>
        </div>

        <div class="mb-4">
          <button
            type="button"
            id="toggle-invite-quota-settings"
            class="flex items-center justify-between w-full p-2 bg-gray-700 rounded hover:bg-gray-600 transition-colors"
            onclick="toggleInviteQuotaSettings()"
          >
            <span class="font-medium">Download Quotas</span>
            <i class="fas fa-chevron-down" id="invite-quota-chevron"></i>
          </button>

          <div id="invite-quota-settings" class="hidden mt-3 p-3 bg-gray-700 rounded">
            <div class="mb-4">
              <label for="invite-daily-quota" class="block text-sm font-medium mb-2">Daily Quota</label>
              <input type="number" id="invite-daily-quota" class="form-input w-full" min="0" step="1" value="0">
              <p class="text-xs text-gray-400 mt-1">Maximum downloads per day (0 = unlimited)</p>
            </div>

            <div class="mb-4">
              <label for="invite-weekly-quota" class="block text-sm font-medium mb-2">Weekly Quota</label>
              <input type="number" id="invite-weekly-quota" class="form-input w-full" min="0" step="1" value="0">
              <p class="text-xs text-gray-400 mt-1">Maximum downloads per week (0 = unlimited)</p>
            </div>

            <div class="mb-2">
              <label for="invite-monthly-quota" class="block text-sm font-medium mb-2">Monthly Quota</label>
              <input type="number" id="invite-monthly-quota" class="form-input w-full" min="0" step="1" value="0">
              <p class="text-xs text-gray-400 mt-1">Maximum downloads per month (0 = unlimited)</p>
            </div>
          </div>
        </div>

        <div class="flex justify-end gap-2 mt-6">
          <button
            type="button"
            onclick="hideCreateInviteModal()"
            class="btn bg-gray-600 text-white hover:bg-gray-700"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="btn btn-primary"
          >
            <i class="fas fa-link mr-1"></i> Create Invite
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Invite Link Modal -->
  <div id="invite-link-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
    <div class="absolute inset-0 bg-black bg-opacity-50"></div>
    <div class="card p-6 max-w-md w-full z-10">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">Invite Link Created</h3>
        <button onclick="hideInviteLinkModal()" class="text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <p class="mb-4">Share this link with the person you want to invite:</p>

      <div class="bg-gray-700 p-3 rounded mb-4">
        <div class="flex">
          <input type="text" id="invite-link-input" class="form-input w-full bg-gray-800 border-0" readonly>
          <button onclick="copyInviteLink()" class="ml-2 px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700" title="Copy to clipboard">
            <i class="fas fa-copy"></i>
          </button>
        </div>
      </div>

      <p class="text-sm text-gray-400 mb-4">This link will expire after the specified time or number of uses.</p>

      <div class="flex justify-end gap-2 mt-6">
        <button
          type="button"
          onclick="hideInviteLinkModal()"
          class="btn btn-primary"
        >
          Done
        </button>
      </div>
    </div>
  </div>

  <!-- Custom JavaScript -->
  <script src="/static/js/sidebar.js"></script>
  <script src="/static/js/topbar.js"></script>
  <script src="/static/js/app.js"></script>

  <!-- Page-specific JavaScript -->
  <script>
    // Direct API call to fetch users
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('Users page loaded');

      // Check if user is admin
      const authResponse = await fetch('/api/auth/status');
      const authData = await authResponse.json();

      if (authData.authenticated && authData.is_admin) {
        console.log('User is authenticated and admin, fetching users');

        try {
          // Fetch users directly
          const response = await fetch('/api/users');
          const data = await response.json();

          console.log('Users API response:', data);

          if (data.success) {
            displayUsersList(data.users);
            updateUserStats(data.users);
          } else {
            document.getElementById('users-list').innerHTML =
              '<div class="text-center p-8 text-red-500">Error fetching users</div>';
          }

          // Fetch invites
          fetchInvites();
        } catch (error) {
          console.error('Error fetching users:', error);
          document.getElementById('users-list').innerHTML =
            '<div class="text-center p-8 text-red-500">Error fetching users. Please try again.</div>';
        }

        // Set up add user form
        const addUserForm = document.getElementById('add-user-form');
        if (addUserForm) {
          addUserForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const username = document.getElementById('new-username').value.trim();
            const password = document.getElementById('new-password').value.trim();
            const isAdmin = document.getElementById('new-is-admin').checked;
            const dailyQuota = parseInt(document.getElementById('new-daily-quota').value) || 0;
            const weeklyQuota = parseInt(document.getElementById('new-weekly-quota').value) || 0;
            const monthlyQuota = parseInt(document.getElementById('new-monthly-quota').value) || 0;

            if (!username || !password) {
              alert('Username and password are required');
              return;
            }

            try {
              const response = await fetch('/api/users', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  username: username,
                  password: password,
                  is_admin: isAdmin,
                  daily_quota: dailyQuota,
                  weekly_quota: weeklyQuota,
                  monthly_quota: monthlyQuota
                })
              });

              const data = await response.json();

              if (data.success) {
                alert('User created successfully');

                // Clear form
                document.getElementById('new-username').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('new-is-admin').checked = false;
                document.getElementById('new-daily-quota').value = '0';
                document.getElementById('new-weekly-quota').value = '0';
                document.getElementById('new-monthly-quota').value = '0';

                // Refresh users list
                location.reload();
              } else {
                alert(data.message || 'Failed to create user');
              }
            } catch (error) {
              console.error('Error creating user:', error);
              alert('Error creating user');
            }
          });
        }

        // Set up create invite button
        const createInviteBtn = document.getElementById('create-invite-btn');
        if (createInviteBtn) {
          createInviteBtn.addEventListener('click', function() {
            showCreateInviteModal();
          });
        }

        // Set up create invite form
        const createInviteForm = document.getElementById('create-invite-form');
        if (createInviteForm) {
          createInviteForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const expiryDays = parseInt(document.getElementById('invite-expiry-days').value) || 7;
            const maxUses = parseInt(document.getElementById('invite-max-uses').value) || 1;
            const isAdmin = document.getElementById('invite-is-admin').checked;
            const dailyQuota = parseInt(document.getElementById('invite-daily-quota').value) || 0;
            const weeklyQuota = parseInt(document.getElementById('invite-weekly-quota').value) || 0;
            const monthlyQuota = parseInt(document.getElementById('invite-monthly-quota').value) || 0;

            try {
              const response = await fetch('/api/invites', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  expiry_days: expiryDays,
                  max_uses: maxUses,
                  is_admin: isAdmin,
                  daily_quota: dailyQuota,
                  weekly_quota: weeklyQuota,
                  monthly_quota: monthlyQuota
                })
              });

              const data = await response.json();

              if (data.success) {
                // Hide the create invite modal
                hideCreateInviteModal();

                // Show the invite link modal with the generated code
                showInviteLinkModal(data.invite.code);

                // Refresh the invites list
                fetchInvites();
              } else {
                alert(data.message || 'Failed to create invite');
              }
            } catch (error) {
              console.error('Error creating invite:', error);
              alert('Error creating invite');
            }
          });
        }
      }
    });

    // Display users list
    function displayUsersList(users) {
      const usersList = document.getElementById('users-list');
      const pendingUsersList = document.getElementById('pending-users-list');

      // Filter out pending users
      const activeUsers = users.filter(user => !user.pending_approval);
      const pendingUsers = users.filter(user => user.pending_approval);

      // Display active users
      if (!activeUsers || activeUsers.length === 0) {
        usersList.innerHTML = '<div class="text-center p-8">No users found</div>';
      } else {
        let html = `
          <!-- Desktop view: Table for larger screens -->
          <div class="hidden md:block overflow-x-auto">
            <table class="table w-full">
              <thead>
                <tr>
                  <th>Username</th>
                  <th>Admin</th>
                  <th>Status</th>
                  <th>Quotas (D/W/M)</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
        `;

        activeUsers.forEach(user => {
          html += `
            <tr>
              <td>${user.username}</td>
              <td>${user.is_admin ? '<span class="text-green-500"><i class="fas fa-check"></i></span>' : '<span class="text-red-500"><i class="fas fa-times"></i></span>'}</td>
              <td>
                ${user.suspended ?
                  '<span class="text-red-500 font-semibold">Suspended</span>' :
                  '<span class="text-green-500 font-semibold">Active</span>'}
              </td>
              <td>
                ${user.is_admin ? '<span class="text-gray-400">N/A (Admin)</span>' :
                  `<span class="text-xs">
                    <span class="${user.quotas.daily.limit > 0 ? 'text-green-500' : 'text-gray-400'}">${user.quotas.daily.used}/${user.quotas.daily.limit || '∞'}</span> /
                    <span class="${user.quotas.weekly.limit > 0 ? 'text-green-500' : 'text-gray-400'}">${user.quotas.weekly.used}/${user.quotas.weekly.limit || '∞'}</span> /
                    <span class="${user.quotas.monthly.limit > 0 ? 'text-green-500' : 'text-gray-400'}">${user.quotas.monthly.used}/${user.quotas.monthly.limit || '∞'}</span>
                  </span>
                  <button
                    class="text-yellow-500 hover:text-yellow-700 ml-2"
                    onclick="showQuotaModal('${user.username}')"
                    title="Edit quotas"
                  >
                    <i class="fas fa-edit"></i>
                  </button>`
                }
              </td>
              <td class="flex space-x-2">
                <button
                  class="text-blue-500 hover:text-blue-700"
                  onclick="showChangePasswordModal('${user.username}')"
                  title="Change password"
                >
                  <i class="fas fa-key"></i>
                </button>
                ${user.suspended ?
                  `<button
                    class="text-green-500 hover:text-green-700"
                    onclick="unsuspendUser('${user.username}')"
                    title="Unsuspend user"
                  >
                    <i class="fas fa-user-check"></i>
                  </button>` :
                  `<button
                    class="text-yellow-500 hover:text-yellow-700"
                    onclick="suspendUser('${user.username}')"
                    title="Suspend user"
                  >
                    <i class="fas fa-user-slash"></i>
                  </button>`
                }
                <button
                  class="text-red-500 hover:text-red-700"
                  onclick="deleteUser('${user.username}')"
                  title="Delete user"
                >
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          `;
        });

        html += `
              </tbody>
            </table>
          </div>

          <!-- Mobile view: Cards for smaller screens -->
          <div class="md:hidden space-y-4">
            ${activeUsers.map(user => `
              <div class="bg-gray-800 rounded-lg p-4 shadow">
                <div class="flex justify-between items-center mb-2">
                  <h3 class="text-lg font-semibold">${user.username}</h3>
                  <div>
                    ${user.is_admin ?
                      '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-900 text-green-300">Admin</span>' :
                      ''}
                    ${user.suspended ?
                      '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-900 text-red-300 ml-1">Suspended</span>' :
                      '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-900 text-green-300 ml-1">Active</span>'}
                  </div>
                </div>

                ${!user.is_admin ? `
                <div class="mb-3 bg-gray-700 p-2 rounded">
                  <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-2 text-xs">
                      <span class="text-gray-400">D:</span>
                      <span class="${user.quotas.daily.limit > 0 ? 'text-green-500' : 'text-gray-400'}">
                        ${user.quotas.daily.used}/${user.quotas.daily.limit || '∞'}
                      </span>
                      <span class="text-gray-400">W:</span>
                      <span class="${user.quotas.weekly.limit > 0 ? 'text-green-500' : 'text-gray-400'}">
                        ${user.quotas.weekly.used}/${user.quotas.weekly.limit || '∞'}
                      </span>
                      <span class="text-gray-400">M:</span>
                      <span class="${user.quotas.monthly.limit > 0 ? 'text-green-500' : 'text-gray-400'}">
                        ${user.quotas.monthly.used}/${user.quotas.monthly.limit || '∞'}
                      </span>
                    </div>
                    <button
                      class="text-yellow-500 hover:text-yellow-700"
                      onclick="showQuotaModal('${user.username}')"
                      title="Edit quotas"
                    >
                      <i class="fas fa-edit"></i>
                    </button>
                  </div>
                </div>
                ` : `
                <div class="mb-3 bg-gray-700 p-2 rounded text-xs">
                  <span class="text-gray-400">Quotas: N/A (Admin)</span>
                </div>
                `}

                <div class="flex justify-end gap-1 mt-2">
                  <button
                    class="px-2 py-1 bg-blue-900 text-blue-300 rounded text-xs flex items-center"
                    onclick="showChangePasswordModal('${user.username}')"
                    title="Change password"
                  >
                    <i class="fas fa-key mr-1"></i>
                    <span>Pass</span>
                  </button>
                  ${user.suspended ?
                    `<button
                      class="px-2 py-1 bg-green-900 text-green-300 rounded text-xs flex items-center"
                      onclick="unsuspendUser('${user.username}')"
                      title="Unsuspend user"
                    >
                      <i class="fas fa-user-check mr-1"></i>
                      <span>Unsus</span>
                    </button>` :
                    `<button
                      class="px-2 py-1 bg-yellow-900 text-yellow-300 rounded text-xs flex items-center"
                      onclick="suspendUser('${user.username}')"
                      title="Suspend user"
                    >
                      <i class="fas fa-user-slash mr-1"></i>
                      <span>Susp</span>
                    </button>`
                  }
                  <button
                    class="px-2 py-1 bg-red-900 text-red-300 rounded text-xs flex items-center"
                    onclick="deleteUser('${user.username}')"
                    title="Delete user"
                  >
                    <i class="fas fa-trash mr-1"></i>
                    <span>Del</span>
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
        `;

        usersList.innerHTML = html;
      }

      // Display pending users
      if (!pendingUsers || pendingUsers.length === 0) {
        pendingUsersList.innerHTML = '<div class="text-center p-8">No pending registrations</div>';
      } else {
        let html = `
          <!-- Desktop view: Table for larger screens -->
          <div class="hidden md:block overflow-x-auto">
            <table class="table w-full">
              <thead>
                <tr>
                  <th>Username</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
        `;

        pendingUsers.forEach(user => {
          html += `
            <tr>
              <td>${user.username}</td>
              <td class="flex space-x-2">
                <button
                  class="text-green-500 hover:text-green-700"
                  onclick="approveUser('${user.username}')"
                  title="Approve user"
                >
                  <i class="fas fa-check"></i>
                </button>
                <button
                  class="text-red-500 hover:text-red-700"
                  onclick="rejectUser('${user.username}')"
                  title="Reject user"
                >
                  <i class="fas fa-times"></i>
                </button>
              </td>
            </tr>
          `;
        });

        html += `
              </tbody>
            </table>
          </div>

          <!-- Mobile view: Cards for smaller screens -->
          <div class="md:hidden space-y-4">
            ${pendingUsers.map(user => `
              <div class="bg-gray-800 rounded-lg p-4 shadow">
                <div class="flex justify-between items-center">
                  <h3 class="text-lg font-semibold">${user.username}</h3>
                  <div class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-900 text-yellow-300">
                    Pending
                  </div>
                </div>
                <div class="flex justify-end gap-1 mt-2">
                  <button
                    class="px-2 py-1 bg-green-900 text-green-300 rounded text-xs flex items-center"
                    onclick="approveUser('${user.username}')"
                    title="Approve user"
                  >
                    <i class="fas fa-check mr-1"></i>
                    <span>Approve</span>
                  </button>
                  <button
                    class="px-2 py-1 bg-red-900 text-red-300 rounded text-xs flex items-center"
                    onclick="rejectUser('${user.username}')"
                    title="Reject user"
                  >
                    <i class="fas fa-times mr-1"></i>
                    <span>Reject</span>
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
        `;

        pendingUsersList.innerHTML = html;
      }
    }

    // Delete user
    async function deleteUser(username) {
      if (!confirm(`Are you sure you want to delete user "${username}"?`)) {
        return;
      }

      try {
        const response = await fetch(`/api/users/${username}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
          alert('User deleted successfully');
          location.reload();
        } else {
          alert(data.message || 'Failed to delete user');
        }
      } catch (error) {
        console.error('Error deleting user:', error);
        alert('Error deleting user');
      }
    }

    // Show change password modal
    function showChangePasswordModal(username) {
      const modal = document.getElementById('change-password-modal');
      const usernameSpan = document.getElementById('change-password-username');
      const form = document.getElementById('change-password-form');

      // Set username
      usernameSpan.textContent = username;
      form.setAttribute('data-username', username);

      // Clear password field
      document.getElementById('change-password-input').value = '';

      // Show modal
      modal.classList.remove('hidden');
    }

    // Hide change password modal
    function hideChangePasswordModal() {
      const modal = document.getElementById('change-password-modal');
      modal.classList.add('hidden');
    }

    // Setup change password form
    document.addEventListener('DOMContentLoaded', function() {
      const changePasswordForm = document.getElementById('change-password-form');

      if (changePasswordForm) {
        changePasswordForm.addEventListener('submit', async function(e) {
          e.preventDefault();

          const username = this.getAttribute('data-username');
          const newPassword = document.getElementById('change-password-input').value.trim();

          if (!newPassword) {
            alert('New password is required');
            return;
          }

          try {
            const response = await fetch(`/api/users/${username}/change-password`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                new_password: newPassword
              })
            });

            const data = await response.json();

            if (data.success) {
              alert('Password changed successfully');
              hideChangePasswordModal();
            } else {
              alert(data.message || 'Failed to change password');
            }
          } catch (error) {
            console.error('Error changing password:', error);
            alert('Error changing password');
          }
        });
      }
    });

    // Show quota modal
    function showQuotaModal(username) {
      const modal = document.getElementById('quota-modal');
      const usernameSpan = document.getElementById('quota-username');
      const form = document.getElementById('quota-form');

      // Set username
      usernameSpan.textContent = username;
      form.setAttribute('data-username', username);

      // Fetch current quotas
      fetchUserQuotasForModal(username);

      // Show modal
      modal.classList.remove('hidden');
    }

    // Hide quota modal
    function hideQuotaModal() {
      const modal = document.getElementById('quota-modal');
      modal.classList.add('hidden');
    }

    // Fetch user quotas for the modal
    async function fetchUserQuotasForModal(username) {
      try {
        // Make sure username is defined
        if (!username) {
          console.error('Username is undefined in fetchUserQuotasForModal');
          return;
        }

        console.log(`Fetching quotas for user: ${username}`);
        const response = await fetch(`/api/users/${username}/quotas`);
        const data = await response.json();

        if (data.success) {
          // Populate form with quotas
          document.getElementById('daily-quota').value = data.quotas.daily.limit || 0;
          document.getElementById('weekly-quota').value = data.quotas.weekly.limit || 0;
          document.getElementById('monthly-quota').value = data.quotas.monthly.limit || 0;
        } else {
          console.error(`Failed to fetch quotas for user ${username}:`, data.message);
          alert(data.message || 'Failed to fetch user quotas');
        }
      } catch (error) {
        console.error(`Error fetching quotas for user ${username}:`, error);
        alert('Error fetching user quotas');
      }
    }

    // Setup quota form
    document.addEventListener('DOMContentLoaded', function() {
      const quotaForm = document.getElementById('quota-form');

      if (quotaForm) {
        quotaForm.addEventListener('submit', async function(e) {
          e.preventDefault();

          const username = this.getAttribute('data-username');
          const dailyQuota = parseInt(document.getElementById('daily-quota').value) || 0;
          const weeklyQuota = parseInt(document.getElementById('weekly-quota').value) || 0;
          const monthlyQuota = parseInt(document.getElementById('monthly-quota').value) || 0;

          try {
            const response = await fetch(`/api/users/${username}/quotas`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                daily_quota: dailyQuota,
                weekly_quota: weeklyQuota,
                monthly_quota: monthlyQuota
              })
            });

            const data = await response.json();

            if (data.success) {
              alert('Quotas updated successfully');
              hideQuotaModal();
              location.reload();
            } else {
              alert(data.message || 'Failed to update quotas');
            }
          } catch (error) {
            console.error('Error updating quotas:', error);
            alert('Error updating quotas');
          }
        });
      }
    });

    // Suspend user
    async function suspendUser(username) {
      if (!confirm(`Are you sure you want to suspend user "${username}"?`)) {
        return;
      }

      try {
        const response = await fetch(`/api/users/${username}/suspend`, {
          method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
          alert('User suspended successfully');
          location.reload();
        } else {
          alert(data.message || 'Failed to suspend user');
        }
      } catch (error) {
        console.error('Error suspending user:', error);
        alert('Error suspending user');
      }
    }

    // Unsuspend user
    async function unsuspendUser(username) {
      if (!confirm(`Are you sure you want to unsuspend user "${username}"?`)) {
        return;
      }

      try {
        const response = await fetch(`/api/users/${username}/unsuspend`, {
          method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
          alert('User unsuspended successfully');
          location.reload();
        } else {
          alert(data.message || 'Failed to unsuspend user');
        }
      } catch (error) {
        console.error('Error unsuspending user:', error);
        alert('Error unsuspending user');
      }
    }

    // Approve user
    async function approveUser(username) {
      if (!confirm(`Are you sure you want to approve user "${username}"?`)) {
        return;
      }

      try {
        const response = await fetch(`/api/users/${username}/approve`, {
          method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
          alert('User approved successfully');
          location.reload();
        } else {
          alert(data.message || 'Failed to approve user');
        }
      } catch (error) {
        console.error('Error approving user:', error);
        alert('Error approving user');
      }
    }

    // Reject user
    async function rejectUser(username) {
      if (!confirm(`Are you sure you want to reject user "${username}"?`)) {
        return;
      }

      try {
        const response = await fetch(`/api/users/${username}/reject`, {
          method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
          alert('User rejected successfully');
          location.reload();
        } else {
          alert(data.message || 'Failed to reject user');
        }
      } catch (error) {
        console.error('Error rejecting user:', error);
        alert('Error rejecting user');
      }
    }

    // Update user stats
    function updateUserStats(users) {
      if (!users) {
        document.getElementById('total-users-count').textContent = '0';
        document.getElementById('admin-users-count').textContent = '0';
        return;
      }

      const totalUsers = users.length;
      const adminUsers = users.filter(user => user.is_admin).length;
      const pendingUsers = users.filter(user => user.pending_approval).length;
      const suspendedUsers = users.filter(user => user.suspended).length;

      document.getElementById('total-users-count').textContent = totalUsers - pendingUsers;
      document.getElementById('admin-users-count').textContent = adminUsers;
    }

    // Toggle quota settings visibility in the add user form
    function toggleQuotaSettings() {
      const quotaSettings = document.getElementById('quota-settings');
      const chevron = document.getElementById('quota-chevron');

      if (quotaSettings.classList.contains('hidden')) {
        quotaSettings.classList.remove('hidden');
        chevron.classList.remove('fa-chevron-down');
        chevron.classList.add('fa-chevron-up');
      } else {
        quotaSettings.classList.add('hidden');
        chevron.classList.remove('fa-chevron-up');
        chevron.classList.add('fa-chevron-down');
      }
    }

    // Toggle invite quota settings visibility
    function toggleInviteQuotaSettings() {
      const quotaSettings = document.getElementById('invite-quota-settings');
      const chevron = document.getElementById('invite-quota-chevron');

      if (quotaSettings.classList.contains('hidden')) {
        quotaSettings.classList.remove('hidden');
        chevron.classList.remove('fa-chevron-down');
        chevron.classList.add('fa-chevron-up');
      } else {
        quotaSettings.classList.add('hidden');
        chevron.classList.remove('fa-chevron-up');
        chevron.classList.add('fa-chevron-down');
      }
    }

    // Fetch invites
    async function fetchInvites() {
      try {
        const invitesList = document.getElementById('invites-list');
        invitesList.innerHTML = '<div class="flex justify-center p-8"><div class="loader"></div></div>';

        const response = await fetch('/api/invites');
        const data = await response.json();

        if (data.success) {
          displayInvitesList(data.invites);
        } else {
          invitesList.innerHTML = '<div class="text-center p-8 text-red-500">Error fetching invites</div>';
        }
      } catch (error) {
        console.error('Error fetching invites:', error);
        document.getElementById('invites-list').innerHTML =
          '<div class="text-center p-8 text-red-500">Error fetching invites. Please try again.</div>';
      }
    }

    // Display invites list
    function displayInvitesList(invites) {
      const invitesList = document.getElementById('invites-list');

      if (!invites || invites.length === 0) {
        invitesList.innerHTML = '<div class="text-center p-8">No active invite links</div>';
        return;
      }

      let html = `
        <div class="space-y-4">
      `;

      invites.forEach(invite => {
        // Format dates
        const createdDate = new Date(invite.created_at).toLocaleString();
        const expiryDate = new Date(invite.expires_at).toLocaleString();

        // Calculate remaining uses
        const remainingUses = invite.max_uses > 0 ? invite.max_uses - invite.uses : '∞';

        html += `
          <div class="bg-gray-800 rounded-lg p-4 shadow">
            <div class="flex justify-between items-center mb-2">
              <div>
                <span class="text-xs text-gray-400">Code:</span>
                <span class="font-mono font-medium">${invite.code}</span>
              </div>
              <div>
                ${invite.is_admin ?
                  '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-900 text-green-300">Admin</span>' :
                  ''}
              </div>
            </div>

            <div class="grid grid-cols-2 gap-2 text-xs mb-3">
              <div>
                <span class="text-gray-400">Created:</span>
                <span>${createdDate}</span>
              </div>
              <div>
                <span class="text-gray-400">Expires:</span>
                <span>${expiryDate}</span>
              </div>
              <div>
                <span class="text-gray-400">Uses:</span>
                <span>${invite.uses}/${invite.max_uses > 0 ? invite.max_uses : '∞'}</span>
              </div>
              <div>
                <span class="text-gray-400">Remaining:</span>
                <span>${remainingUses}</span>
              </div>
            </div>

            <div class="flex justify-between items-center">
              <button
                class="text-blue-500 hover:text-blue-700 text-sm flex items-center"
                onclick="copyInviteCode('${invite.code}')"
              >
                <i class="fas fa-copy mr-1"></i> Copy Link
              </button>

              <button
                class="text-red-500 hover:text-red-700 text-sm flex items-center"
                onclick="deleteInvite('${invite.code}')"
              >
                <i class="fas fa-trash mr-1"></i> Delete
              </button>
            </div>
          </div>
        `;
      });

      html += `</div>`;
      invitesList.innerHTML = html;
    }

    // Show create invite modal
    function showCreateInviteModal() {
      const modal = document.getElementById('create-invite-modal');
      modal.classList.remove('hidden');
    }

    // Hide create invite modal
    function hideCreateInviteModal() {
      const modal = document.getElementById('create-invite-modal');
      modal.classList.add('hidden');
    }

    // Show invite link modal
    function showInviteLinkModal(inviteCode) {
      const modal = document.getElementById('invite-link-modal');
      const linkInput = document.getElementById('invite-link-input');

      // Create the full invite link
      const inviteLink = `${window.location.origin}/register?invite=${inviteCode}`;
      linkInput.value = inviteLink;

      modal.classList.remove('hidden');
    }

    // Hide invite link modal
    function hideInviteLinkModal() {
      const modal = document.getElementById('invite-link-modal');
      modal.classList.add('hidden');
    }

    // Copy invite link to clipboard
    function copyInviteLink() {
      const linkInput = document.getElementById('invite-link-input');
      linkInput.select();
      document.execCommand('copy');
      alert('Invite link copied to clipboard!');
    }

    // Copy invite code to clipboard
    function copyInviteCode(code) {
      const inviteLink = `${window.location.origin}/register?invite=${code}`;

      // Create a temporary input element
      const tempInput = document.createElement('input');
      tempInput.value = inviteLink;
      document.body.appendChild(tempInput);

      // Select and copy
      tempInput.select();
      document.execCommand('copy');

      // Remove the temporary element
      document.body.removeChild(tempInput);

      alert('Invite link copied to clipboard!');
    }

    // Delete invite
    async function deleteInvite(inviteCode) {
      if (!confirm(`Are you sure you want to delete this invite link?`)) {
        return;
      }

      try {
        const response = await fetch(`/api/invites/${inviteCode}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
          alert('Invite link deleted successfully');
          fetchInvites();
        } else {
          alert(data.message || 'Failed to delete invite link');
        }
      } catch (error) {
        console.error('Error deleting invite:', error);
        alert('Error deleting invite link');
      }
    }
  </script>
</body>
</html>
